networks:
  internal:
    internal: true
  external:
  reverse-proxy_internal:
    external: true
    
services:
  immichserver:
    image: ghcr.io/immich-app/immich-server:release
    env_file:
      - ../stack.env
    environment:
      - DB_HOSTNAME=postgres
      - DB_PORT=5432
      - DB_DATABASE_NAME=immich
      - DB_USERNAME=$DB_USERNAME
      - DB_PASSWORD=$DB_PASSWORD
      - TZ=America/Chicago
    volumes:
      - /mnt/user/cloud/immich:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    networks:
      - external
      - internal
      - reverse-proxy_internal
    ports:
      - 2283:2283
    depends_on:
      - redis
      - postgres
    restart: unless-stopped

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release
    volumes:
      - model-cache:/cache
    networks:
      - internal
    restart: unless-stopped

  redis:
    image: docker.io/redis:6.2-alpine
    healthcheck:
      test: redis-cli ping || exit 1
    networks:
      - internal
    restart: unless-stopped

  postgres:
    image: docker.io/tensorchord/pgvecto-rs:pg14-v0.2.0@sha256:90724186f0a3517cf6914295b5ab410db9ce23190a2d9d0b9dd6463e3fa298f0
    command: ["postgres", "-c" ,"shared_preload_libraries=vectors.so", "-c", 'search_path="$$user", public, vectors', "-c", "logging_collector=on", "-c", "max_wal_size=2GB", "-c", "shared_buffers=512MB", "-c", "wal_compression=on"]
    env_file:
      - ../stack.env
    environment:
      POSTGRES_PASSWORD: $DB_PASSWORD
      POSTGRES_USER: $DB_USERNAME
      POSTGRES_DB: immich
      POSTGRES_INITDB_ARGS: '--data-checksums'
    volumes:
      - /mnt/user/appdata/immich/postgresql:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: pg_isready --dbname='immich' --username='$DB_USERNAME' || exit 1; Chksum="$$(psql --dbname='immich' --username='$DB_USERNAME' --tuples-only --no-align --command='SELECT COALESCE(SUM(checksum_failures), 0) FROM pg_stat_database')"; echo "checksum failure count is $$Chksum"; [ "$$Chksum" = '0' ] || exit 1
      interval: 5m
    restart: unless-stopped

  immich-kiosk-people:
    image: damongolding/immich-kiosk:latest
    env_file:
      - ../stack.env
    environment:
      TZ: "America/Chicago"
      # Required settings
      KIOSK_IMMICH_API_KEY: $IMMICH_API_TOKEN
      KIOSK_IMMICH_URL: "immichserver:2283"
      # Clock
      KIOSK_SHOW_TIME: true
      KIOSK_TIME_FORMAT: 12
      KIOSK_SHOW_DATE: true
      KIOSK_DATE_FORMAT: "DDDD MMMM DD YYYY"
      # Kiosk behaviour
      KIOSK_REFRESH: 60
      KIOSK_DISABLE_SCREENSAVER: true
      KIOSK_OPTIMIZE_IMAGES: false
      # Asset sources
      KIOSK_SHOW_ARCHIVED: false
      KIOSK_ALBUM: "bff87026-9e29-4c7d-b6ae-53c6ff5f78ab,8a19fa9d-0730-4eec-b1e2-c593eaa489fe,41fba02e-4097-4854-9c0f-d0b89b7a0e71"
      KIOSK_EXCLUDED_ALBUMS: "acc4b483-6605-4de1-91eb-54e9cc1654cc,ab956080-ee3e-4ee2-a071-7d104002b798"
      KIOSK_PERSON: "f459f375-aa1e-4b91-b428-a1e491a62dcb,330ae4b2-07e4-4141-bf28-f1a23781bb00"
      # UI
      KIOSK_DISABLE_UI: false
      KIOSK_FRAMELESS: false
      KIOSK_HIDE_CURSOR: false
      KIOSK_FONT_SIZE: 100
      KIOSK_BACKGROUND_BLUR: true
      KIOSK_THEME: fade
      KIOSK_LAYOUT: single
      # Sleep mode
      KIOSK_SLEEP_START: ""
      KIOSK_SLEEP_END: ""
      # Transistion options
      KIOSK_TRANSITION: NONE
      KIOSK_FADE_TRANSITION_DURATION: 1
      KIOSK_CROSS_FADE_TRANSITION_DURATION: 1
      # Image display settings
      KIOSK_SHOW_PROGRESS: false
      KIOSK_IMAGE_FIT: "contain"
      KIOSK_IMAGE_EFFECT: "smart-zoom"
      KIOSK_IMAGE_ZOOM_AMOUNT: 120
      KIOSK_USE_ORIGINAL_IMAGE: false
      # Image metadata
      KIOSK_SHOW_ALBUM_NAME: false
      KIOSK_SHOW_PERSON_NAME: false
      KIOSK_SHOW_IMAGE_TIME: false
      KIOSK_IMAGE_TIME_FORMAT: 24
      KIOSK_SHOW_IMAGE_DATE: false
      KIOSK_IMAGE_DATE_FORMAT: YYYY-MM-DD
      KIOSK_SHOW_IMAGE_DESCRIPTION: false
      KIOSK_SHOW_IMAGE_EXIF: false
      KIOSK_SHOW_IMAGE_LOCATION: false
      KIOSK_HIDE_COUNTRIES: ""
      KIOSK_SHOW_IMAGE_ID: false
      KIOSK_SHOW_MORE_INFO: true
      KIOSK_SHOW_MORE_INFO_IMAGE_LINK: true
      KIOSK_SHOW_MORE_INFO_QR_CODE: true
      # Kiosk settings
      KIOSK_WATCH_CONFIG: false
      KIOSK_FETCHED_ASSETS_SIZE: 1000
      KIOSK_HTTP_TIMEOUT: 20
      KIOSK_PASSWORD: ""
      KIOSK_CACHE: true
      KIOSK_PREFETCH: true
      KIOSK_ASSET_WEIGHTING: true
      KIOSK_PORT: 3000
    networks:
      - internal
    depends_on:
      - immichserver
    restart: unless-stopped

  immich-kiosk-animals:
    image: damongolding/immich-kiosk:latest
    env_file:
      - ../stack.env
    environment:
      TZ: "America/Chicago"
      # Required settings
      KIOSK_IMMICH_API_KEY: $IMMICH_API_TOKEN
      KIOSK_IMMICH_URL: "immichserver:2283"
      # Clock
      KIOSK_SHOW_TIME: true
      KIOSK_TIME_FORMAT: 12
      KIOSK_SHOW_DATE: true
      KIOSK_DATE_FORMAT: "DDDD MMMM DD YYYY"
      # Kiosk behaviour
      KIOSK_REFRESH: 60
      KIOSK_DISABLE_SCREENSAVER: true
      KIOSK_OPTIMIZE_IMAGES: false
      # Asset sources
      KIOSK_SHOW_ARCHIVED: false
      KIOSK_ALBUM: "baa70b3a-7e4e-42f2-bc37-6717048ccbb7"
      KIOSK_EXCLUDED_ALBUMS: ""
      KIOSK_PERSON: ""
      # UI
      KIOSK_DISABLE_UI: false
      KIOSK_FRAMELESS: false
      KIOSK_HIDE_CURSOR: false
      KIOSK_FONT_SIZE: 100
      KIOSK_BACKGROUND_BLUR: true
      KIOSK_THEME: fade
      KIOSK_LAYOUT: single
      # Sleep mode
      KIOSK_SLEEP_START: ""
      KIOSK_SLEEP_END: ""
      # Transistion options
      KIOSK_TRANSITION: NONE
      KIOSK_FADE_TRANSITION_DURATION: 1
      KIOSK_CROSS_FADE_TRANSITION_DURATION: 1
      # Image display settings
      KIOSK_SHOW_PROGRESS: false
      KIOSK_IMAGE_FIT: "contain"
      KIOSK_IMAGE_EFFECT: ""
      KIOSK_IMAGE_ZOOM_AMOUNT: 120
      KIOSK_USE_ORIGINAL_IMAGE: false
      # Image metadata
      KIOSK_SHOW_ALBUM_NAME: false
      KIOSK_SHOW_PERSON_NAME: false
      KIOSK_SHOW_IMAGE_TIME: false
      KIOSK_IMAGE_TIME_FORMAT: 24
      KIOSK_SHOW_IMAGE_DATE: false
      KIOSK_IMAGE_DATE_FORMAT: YYYY-MM-DD
      KIOSK_SHOW_IMAGE_DESCRIPTION: false
      KIOSK_SHOW_IMAGE_EXIF: false
      KIOSK_SHOW_IMAGE_LOCATION: false
      KIOSK_HIDE_COUNTRIES: ""
      KIOSK_SHOW_IMAGE_ID: false
      KIOSK_SHOW_MORE_INFO: true
      KIOSK_SHOW_MORE_INFO_IMAGE_LINK: true
      KIOSK_SHOW_MORE_INFO_QR_CODE: true
      # Kiosk settings
      KIOSK_WATCH_CONFIG: false
      KIOSK_FETCHED_ASSETS_SIZE: 1000
      KIOSK_HTTP_TIMEOUT: 20
      KIOSK_PASSWORD: ""
      KIOSK_CACHE: true
      KIOSK_PREFETCH: true
      KIOSK_ASSET_WEIGHTING: true
      KIOSK_PORT: 3000
    networks:
      - internal
    depends_on:
      - immichserver
    restart: unless-stopped

  immich-kiosk-lb:
    image: ghcr.io/agentgodzilla/caddy-cloudflare-dynamicdns:latest
    volumes:
      - /mnt/user/appdata/immich/caddy/data:/data
      - /mnt/user/appdata/immich/caddy/config:/config
      - /mnt/user/appdata/immich/caddy/Caddyfile:/etc/caddy/Caddyfile
    networks:
      - internal
      - external
    ports:
      - 3002:80
    depends_on:
      - immich-kiosk-people
      - immich-kiosk-animals
    restart: unless-stopped

volumes:
  model-cache:
